<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relat√≥rio de Carregamento MM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöõ</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    :root {
      --primary-cyan: #00ffff;
      --primary-blue: #0066ff;
      --secondary-purple: #9900ff;
      --accent-pink: #ff0066;
      --dark-bg: #0a0a0f;
      --card-bg: rgba(16, 16, 32, 0.8);
      --border-glow: rgba(0, 255, 255, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #b3b3cc;
      --gradient-primary: linear-gradient(135deg, var(--primary-cyan), var(--primary-blue));
      --gradient-secondary: linear-gradient(135deg, var(--secondary-purple), var(--accent-pink));
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

      /* Estilos para tela de login */
#loginOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--dark-bg);
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(0, 255, 255, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(153, 0, 255, 0.15) 0%, transparent 50%);
  z-index: 10000;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(20px);
}

.login-container {
  background: var(--card-bg);
  backdrop-filter: blur(30px);
  border: 2px solid var(--border-glow);
  border-radius: 25px;
  padding: 3rem 2rem;
  text-align: center;
  box-shadow: 
    0 30px 60px rgba(0, 0, 0, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  position: relative;
  overflow: hidden;
  max-width: 400px;
  width: 90%;
  animation: loginSlideIn 0.8s ease;
}

.login-container::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: var(--gradient-primary);
  border-radius: 25px;
  z-index: -1;
  opacity: 0.2;
  animation: loginGlow 2s ease-in-out infinite alternate;
}

.login-header {
  margin-bottom: 2rem;
}

.login-header h1 {
  font-family: 'Orbitron', monospace;
  font-size: 2rem;
  font-weight: 900;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 0.5rem;
  animation: glow 2s ease-in-out infinite alternate;
}

.login-header .subtitle {
  font-size: 1rem;
  color: var(--text-secondary);
  font-weight: 300;
  letter-spacing: 1px;
}

.login-icon {
  font-size: 4rem;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
  animation: pulse 2s infinite;
}

.pin-container {
  margin: 2rem 0;
}

.pin-label {
  font-size: 1.1rem;
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.pin-inputs {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 2rem;
}

.pin-digit {
  width: 60px;
  height: 60px;
  background: rgba(16, 16, 32, 0.8);
  border: 2px solid rgba(0, 255, 255, 0.3);
  border-radius: 15px;
  color: var(--text-primary);
  font-size: 1.8rem;
  font-weight: 700;
  font-family: 'Orbitron', monospace;
  text-align: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.pin-digit:focus {
  outline: none;
  border-color: var(--primary-cyan);
  box-shadow: 
    0 0 20px rgba(0, 255, 255, 0.4),
    inset 0 0 10px rgba(0, 255, 255, 0.1);
  transform: scale(1.05);
}

.pin-digit.filled {
  border-color: var(--primary-cyan);
  background: rgba(0, 255, 255, 0.1);
  box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
}

.pin-digit.error {
  border-color: var(--accent-pink);
  background: rgba(255, 0, 102, 0.1);
  box-shadow: 0 0 15px rgba(255, 0, 102, 0.3);
  animation: shake 0.5s ease;
}

.login-buttons {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.btn-login {
  padding: 1rem 2rem;
  border: none;
  border-radius: 15px;
  font-family: 'Rajdhani', sans-serif;
  font-size: 1.1rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.btn-login::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn-login:hover::before {
  left: 100%;
}

.btn-entrar {
  background: var(--gradient-primary);
  color: white;
  box-shadow: 0 10px 30px rgba(0, 102, 255, 0.3);
}

.btn-entrar:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: 0 15px 40px rgba(0, 102, 255, 0.4);
}

.btn-entrar:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-limpar {
  background: var(--gradient-secondary);
  color: white;
  box-shadow: 0 10px 30px rgba(153, 0, 255, 0.3);
}

.btn-limpar:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 40px rgba(153, 0, 255, 0.4);
}

.error-message {
  color: var(--accent-pink);
  font-size: 0.9rem;
  margin-top: 1rem;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.error-message.show {
  opacity: 1;
  animation: errorPulse 0.5s ease;
}

.security-info {
  margin-top: 2rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
  opacity: 0.7;
}

@keyframes loginSlideIn {
  from {
    opacity: 0;
    transform: translateY(100px) scale(0.8);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes loginGlow {
  from {
    opacity: 0.1;
  }
  to {
    opacity: 0.3;
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

@keyframes errorPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

@media (max-width: 480px) {
  .login-container {
    padding: 2rem 1.5rem;
  }
  
  .pin-inputs {
    gap: 0.5rem;
  }
  
  .pin-digit {
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
  }
}

    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--dark-bg);
      background-image: 
        radial-gradient(circle at 25% 25%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(153, 0, 255, 0.1) 0%, transparent 50%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 1rem;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(45deg, transparent 49%, rgba(0, 255, 255, 0.03) 50%, transparent 51%),
        linear-gradient(-45deg, transparent 49%, rgba(153, 0, 255, 0.03) 50%, transparent 51%);
      background-size: 20px 20px;
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      animation: slideInUp 0.8s ease;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .header h1 {
      font-family: 'Orbitron', monospace;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 900;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
      animation: glow 2s ease-in-out infinite alternate;
    }

    .header .subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      font-weight: 300;
      letter-spacing: 1px;
    }

    .session-info {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-glow);
      border-radius: 15px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .session-id {
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      color: var(--primary-cyan);
      font-size: 1.1rem;
    }

    .session-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .form-container {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-glow);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .form-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: var(--gradient-primary);
      border-radius: 20px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .form-container:hover::before {
      opacity: 0.1;
    }

    .section {
      margin-bottom: 2rem;
      position: relative;
    }

    .section-title {
      font-family: 'Orbitron', monospace;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-cyan);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, var(--primary-cyan), transparent);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      position: relative;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 1rem;
      background: rgba(16, 16, 32, 0.6);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: 'Rajdhani', sans-serif;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-cyan);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .form-input::placeholder {
      color: rgba(179, 179, 204, 0.6);
    }

    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 10px 30px rgba(0, 102, 255, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(0, 102, 255, 0.4);
    }

    .btn-secondary {
      background: var(--gradient-secondary);
      color: white;
      box-shadow: 0 10px 30px rgba(153, 0, 255, 0.3);
    }

    .btn-secondary:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(153, 0, 255, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff0066, #ff3366);
      color: white;
      box-shadow: 0 10px 30px rgba(255, 0, 102, 0.3);
    }

    .btn-danger:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(255, 0, 102, 0.4);
    }

    .btn-info {
      background: linear-gradient(135deg, #17a2b8, #20c997);
      color: white;
      box-shadow: 0 10px 30px rgba(23, 162, 184, 0.3);
    }

    .btn-info:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(23, 162, 184, 0.4);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }

    .time-controls {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      align-items: end;
    }

    .counter-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(16, 16, 32, 0.6);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 12px;
      padding: 0.5rem;
      backdrop-filter: blur(10px);
    }

    .counter-controls .form-input {
      border: none;
      background: transparent;
      text-align: center;
      width: 80px;
      padding: 0.5rem;
    }

    .counter-btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      background: var(--gradient-primary);
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .counter-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .checkbox-item {
      position: relative;
    }

    .checkbox-item input[type="checkbox"] {
      display: none;
    }

    .checkbox-item label {
      display: block;
      padding: 0.7rem 0.5rem;
      background: rgba(16, 16, 32, 0.6);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    .checkbox-item input[type="checkbox"]:checked + label {
      background: var(--gradient-primary);
      border-color: var(--primary-cyan);
      box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .seal-controls {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 0.5rem;
      align-items: end;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--border-glow);
      border-radius: 20px;
      padding: 2rem;
      position: relative;
      max-width: 500px;
      width: 90%;
      backdrop-filter: blur(20px);
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--gradient-secondary);
      border: none;
      border-radius: 8px;
      color: white;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .readonly-field {
      background: rgba(16, 16, 32, 0.4) !important;
      border-color: rgba(179, 179, 204, 0.2) !important;
      color: var(--text-secondary) !important;
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }

    .autocomplete-container {
      position: relative;
    }

    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border-glow);
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      backdrop-filter: blur(20px);
      display: none;
    }

    .autocomplete-suggestion {
      padding: 0.8rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }

    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.selected {
      background: rgba(0, 255, 255, 0.1);
    }

    .autocomplete-suggestion:last-child {
      border-bottom: none;
    }

    .session-list {
      display: grid;
      gap: 0.5rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .session-item {
      background: rgba(16, 16, 32, 0.6);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .session-item:hover {
      background: rgba(0, 255, 255, 0.1);
      border-color: var(--primary-cyan);
    }

    .session-item.active {
      background: var(--gradient-primary);
      border-color: var(--primary-cyan);
    }

    .session-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .session-item-id {
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .session-item-actions {
      display: flex;
      gap: 0.25rem;
    }

    .session-item-info {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    .status-new {
      background: #ffc107;
    }

    .status-progress {
      background: #17a2b8;
    }

    .status-completed {
      background: #28a745;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      }
      to {
        text-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
      }
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      }
      50% {
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
      }
    }

    .scanning {
      animation: pulse 1s infinite;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .actions {
        grid-template-columns: 1fr;
      }

      .checkbox-grid {
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      }

      .session-controls {
        justify-content: center;
        width: 100%;
      }

      .session-info {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>

<div id="loginOverlay">
  <div class="login-container">
    <div class="login-header">
      <div class="login-icon">üîê</div>
      <h1>Acesso Restrito</h1>
      <div class="subtitle">Formul√°rio de Carregamento MM</div>
    </div>
    
    <div class="pin-container">
      <div class="pin-label">Digite o PIN:</div>
      <div class="pin-inputs">
        <input type="password" class="pin-digit" maxlength="1" id="pin1" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" id="pin2" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" id="pin3" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" id="pin4" inputmode="numeric">
      </div>
      
      <div class="login-buttons">
        <button type="button" id="btnEntrar" class="btn-login btn-entrar" disabled>
          üöÄ Entrar no Sistema
        </button>
        <button type="button" id="btnLimpar" class="btn-login btn-limpar">
          üóëÔ∏è Limpar PIN
        </button>
      </div>
      
      <div id="errorMessage" class="error-message">
        ‚ùå PIN incorreto! Tente novamente.
      </div>
    </div>
    
    <div class="security-info">
      üõ°Ô∏è Sistema protegido com autentica√ß√£o PIN <br>
      Proibido o compartilhamento do PIN e uso n√£o autorizado desse sistema. <br>
      Cria√ß√£o e desenvolvimento: Igor Alexandre Padovan <br>
      Uso pessoal.<br>
      v 2.52
    </div>
  </div>
</div>

  <div class="container">
    <div class="header">
      <h1><i class="bi bi-truck"></i> CARREGAMENTO MM</h1>
    
    </div>

    <!-- Informa√ß√µes da Sess√£o Atual -->
    <div class="session-info">
      <div class="session-id">
        <i class="bi bi-layers"></i>
        <span id="current-session">Sess√£o: Carregando...</span>
      </div>
      <div class="session-controls">
        <button type="button" onclick="novaInstancia()" class="btn btn-info btn-small">
          <i class="bi bi-plus-circle"></i> Nova sess√£o
        </button>
        <button type="button" onclick="gerenciarInstancias()" class="btn btn-secondary btn-small">
          <i class="bi bi-list"></i> Gerenciar Sess√µes
        </button>
      </div>
    </div>
<div id="reportConsolidadoModal" class="modal">
  <div class="modal-content">
    <button onclick="fecharReportConsolidado()" class="modal-close">
      <i class="bi bi-x-lg"></i>
    </button>
    <div class="section-title" style="margin-bottom: 1rem;">
      <i class="bi bi-bar-chart"></i>
      Report Consolidado por Rota
    </div>
    
    <div class="form-group" style="margin-bottom: 1rem;">
      <label class="form-label">Selecione a Data</label>
      <input type="date" id="dataReportConsolidado" class="form-input">
    </div>
    
    <div class="form-group" style="margin-bottom: 1rem;">
      <label class="form-label">Selecione a Rota</label>
      <select id="rotaReportConsolidado" class="form-select">
        <option value="">Selecione uma rota</option>
        <option value="Aragua√≠na">Aragua√≠na (A)</option>
        <option value="Gurupi">Gurupi (B)</option>
        <option value="Guara√≠">Guara√≠ (C)</option>
        <option value="Luiz Eduardo Magalh√£es">Luiz Eduardo Magalh√£es (H)</option>
        <option value="Barreiras">Barreiras (I)</option>
      </select>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: center;">
      <button type="button" onclick="processarReportConsolidado()" class="btn btn-primary">
        <i class="bi bi-file-earmark-text"></i> Gerar Report
      </button>
    </div>
  </div>
</div>

<!-- Modal para Gerenciar Inst√¢ncias -->
<div id="gerenciarModal" class="modal">
  <div class="modal-content">
    <button onclick="fecharGerenciar()" class="modal-close">
      <i class="bi bi-x-lg"></i>
    </button>
    <div class="section-title" style="margin-bottom: 1rem;">
      <i class="bi bi-list"></i>
      Gerenciar Inst√¢ncias
    </div>
    <div id="session-list" class="session-list"></div>
    <div style="margin-top: 1rem; text-align: center; display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
      <button type="button" onclick="exportarTodas()" class="btn btn-info btn-small">
        <i class="bi bi-download"></i> Exportar Todas
      </button>
      <button type="button" onclick="importarSessoes()" class="btn btn-secondary btn-small">
        <i class="bi bi-upload"></i> Importar
      </button>
      <button type="button" onclick="excluirTodasSessoes()" class="btn btn-danger btn-small">
        <i class="bi bi-trash"></i> Excluir Todas
      </button>
    </div>
    <input type="file" id="fileImport" accept=".json" style="display: none;" onchange="processarImportacao(this)">
  </div>
</div>


    <div class="form-container">
      <form id="form-carregamento">
        <!-- Se√ß√£o de Informa√ß√µes B√°sicas -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-calendar-event"></i>
            Informa√ß√µes B√°sicas
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Data</label>
              <div class="time-controls">
                <input type="date" id="data" name="data" class="form-input">
                <button type="button" onclick="inserirData()" class="btn btn-primary btn-small">Hoje</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Rota</label>
              <select id="rota-select" class="form-select">
                <option value="">Selecione uma rota</option>
                <option value="Aragua√≠na">Aragua√≠na (A)</option>
                <option value="Gurupi">Gurupi (B)</option>
                <option value="Guara√≠">Guara√≠ (C)</option>
                <option value="Luiz Eduardo Magalh√£es">Luiz Eduardo Magalh√£es (H)</option>
                <option value="Barreiras">Barreiras (I)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Doca</label>
              <select id="doca" name="doca" class="form-select">
                <option value="01">01</option><option value="02">02</option><option value="03">03</option>
                <option value="04">04</option><option value="05">05</option><option value="06">06</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo do Ve√≠culo</label>
              <select id="tipoVeiculo" name="tipoVeiculo" onchange="verificarTipoVeiculo()" class="form-select">
                <option value="Carreta">Carreta</option><option value="Truck">Truck</option>
                <option value="Toco">Toco</option><option value="3/4">3/4</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Ve√≠culo -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-truck-front"></i>
            Dados do Ve√≠culo
          </div>
          <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Selecione a placa do Ve√≠culo</label>
              <select onchange="onSelectChange(this)" class="form-select">
                <option value="">Selecione...</option>
                <option value="manual">Inserir Manualmente</option>
                <option value="MSR - PQA8867 / JAE3D30">MSR - PQA8867 / JAE3D30</option>
                <option value="MSR - DRX8D24 / JAW3D30">MSR - DRX8D24 / JAW3D30</option>
                <option value="MSR - RBL4J23 / ONC3I65">MSR - RBL4J23 / ONC3I65</option>
                <option value="MSR - MXB3387 / MLO6F04">MSR - MXB3387 (Dc 05) / MLO6F04</option>
                <option value="MSR - NWE5A88 / ONG5H07">MSR - NWE5A88 (Dc 06) / ONG5H07</option>

                <option value="RODACOP - TCK5H69 / HDE8J16">RODACOP - TCK5H69 / HDE8J16</option>
                <option value="RODACOP - FOF5B57 / RUK2H11">RODACOP - FOF5B57 / RUK2H11</option>
                <option value="RODACOP - FTB1F75 / RUKJ2J60">RODACOP - FTB1F75 / RUKJ2J60</option>
                <option value="RODACOP - RVB2C09">RODACOP - RVB2C09</option>

                <option value="RODACOP - RVB1J25">RODACOP - RVB1J25</option>
                <option value="RODACOP - OFC7H98">RODACOP - OFC7H98</option>
                <option value="RODACOP - PVB0G08">RODACOP - PVB0G08</option>
                <option value="RODACOP - RUK9J07">RODACOP - RUK9J07</option>

                <option value="RODACOP - OQG8012">RODACOP - OQG8012</option>
                <option value="RODACOP - RFR7E89">RODACOP - RFR7E89</option>
                <option value="RODACOP - OLM1I23">RODACOP - OLM1I23</option>
                <option value="RODACOP - QKA6J98">RODACOP - QKA6J98</option>
                <option value="RODACOP - RSE9F12">RODACOP - RSE9F12</option>
                <option value="RODACOP - RIN8H85">RODACOP - RIN8H85</option>
                <option value="RODACOP - OLH2G94">RODACOP - OLH2G94</option>

                <option value="KIA5I83">KIA5I83</option>
                <option value="PRO5B99">PRO5B99</option>
                <option value="RMB6C84">RMB6C84 - RMB6D04</option>



              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Placa Ba√∫</label>
              <input type="text" id="placaPrimaria" placeholder="Placa Ba√∫" class="form-input" disabled>
            </div>
            <div class="form-group">
              <label class="form-label">Placa Ve√≠culo</label>
              <input type="text" id="placaSecundaria" placeholder="Placa Ve√≠culo ou Cavalo" class="form-input" disabled>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Motorista -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-person-badge"></i>
            Dados do Motorista
          </div>
          <div class="form-grid">
            <div class="form-group autocomplete-container">
              <label class="form-label">Nome do Motorista</label>
              <input type="text" id="nomeMotorista" placeholder="Digite o nome do motorista" class="form-input" autocomplete="off">
              <div id="suggestions" class="autocomplete-suggestions"></div>
            </div>
            <div class="form-group">
              <label class="form-label">Telefone</label>
              <input type="text" id="telefoneMotorista" placeholder="Digite o telefone" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">CPF</label>
              <input type="text" id="cpfMotorista" placeholder="Digite o CPF" class="form-input">
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Hor√°rios -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-clock"></i>
            Controle de Hor√°rios
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Chegada Unidade</label>
              <div class="time-controls">
                <input type="time" id="horaChegada" class="form-input">
                <button type="button" onclick="registrarHoraComConfirmacao('horaChegada')" class="btn btn-primary btn-small">Registrar</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Hora Doca</label>
              <div class="time-controls">
                <input type="time" id="horaDoca" class="form-input">
                <button type="button" onclick="registrarHoraComConfirmacao('horaDoca')" class="btn btn-primary btn-small">Registrar</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">In√≠cio Carregamento</label>
              <div class="time-controls">
                <input type="time" id="horaInicio" class="form-input">
                <button type="button" onclick="registrarHoraComConfirmacao('horaInicio')" class="btn btn-primary btn-small">Registrar</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">T√©rmino Carregamento</label>
              <div class="time-controls">
                <input type="time" id="horaTermino" class="form-input">
                <button type="button" onclick="confirmarFotoBauAberto()" class="btn btn-secondary btn-small">Registrar</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Sa√≠da</label>
              <div class="time-controls">
                <input type="time" id="horaSaida" class="form-input">
                <button type="button" onclick="registrarHoraComConfirmacao('horaSaida')" class="btn btn-primary btn-small">Registrar</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Previs√£o de Destino</label>
              <input type="time" id="previsaoDestino" placeholder="Digite a previs√£o de destino" class="form-input">
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Lacres -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-shield-lock"></i>
            Controle de Lacres
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Lacre Ba√∫</label>
              <div class="seal-controls">
                <input type="text" id="lacreBau" class="form-input" inputmode="numeric">
                <button type="button" onclick="scanQRCode('lacreBau')" class="btn btn-secondary btn-small">
                  <i class="bi bi-qr-code-scan"></i>
                </button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Lacre Lateral 1</label>
              <div class="seal-controls">
                <input type="text" id="lacreLateral1" class="form-input" inputmode="numeric">
                <button type="button" onclick="scanQRCode('lacreLateral1')" class="btn btn-secondary btn-small">
                  <i class="bi bi-qr-code-scan"></i>
                </button>
                <label style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; margin: 0;">
                  <input type="checkbox" id="lateral1NaoUsa"> N√£o utiliza
                </label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Lacre Lateral 2</label>
              <div class="seal-controls">
                <input type="text" id="lacreLateral2" class="form-input" inputmode="numeric">
                <button type="button" onclick="scanQRCode('lacreLateral2')" class="btn btn-secondary btn-small">
                  <i class="bi bi-qr-code-scan"></i>
                </button>
                <label style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; margin: 0;">
                  <input type="checkbox" id="lateral2NaoUsa"> 
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Cargas -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-boxes"></i>
            Controle de Cargas
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Volumosos</label>
              <div class="counter-controls">
                <button type="button" onclick="alterarContagem('volumoso', -1)" class="counter-btn">-</button>
                <input type="number" id="volumoso" value="0" min="0" class="form-input">
                <button type="button" onclick="alterarContagem('volumoso', 1)" class="counter-btn">+</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Gaiolas</label>
              <div class="counter-controls">
                <button type="button" onclick="alterarContagem('gaiola', -1)" class="counter-btn">-</button>
                <input type="number" id="gaiola" value="0" min="0" class="form-input">
                <button type="button" onclick="alterarContagem('gaiola', 1)" class="counter-btn">+</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Manga Pallets</label>
              <div class="counter-controls">
                <button type="button" onclick="alterarContagem('mangaPallet', -1)" class="counter-btn">-</button>
                <input type="number" id="mangaPallet" value="0" min="0" class="form-input">
                <button type="button" onclick="alterarContagem('mangaPallet', 1)" class="counter-btn">+</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Rotas XPT -->
        <div class="section">
          <div class="section-title">
            <i class="bi bi-geo-alt"></i>
            Rotas XPT
          </div>
          <div class="checkbox-grid" id="rotasCheckboxes"></div>
        </div>

        <!-- A√ß√µes -->
        <div class="actions">
          <button type="button" onclick="gerarReport()" class="btn btn-primary">
            <i class="bi bi-file-earmark-pdf"></i> Gerar Relat√≥rio
          </button>
          <button type="button" onclick="salvarInstancia()" class="btn btn-info">
            <i class="bi bi-save"></i> Salvar Sess√£o
          </button>
          <button type="button" onclick="limparFormulario()" class="btn btn-danger">
            <i class="bi bi-trash"></i> Limpar Tudo
          </button>
          <button type="button" onclick="gerarReportConsolidado()" class="btn btn-info">
           <i class="bi bi-bar-chart"></i> Gerar Report Consolidado
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para Scanner QR -->
  <div id="qrScannerModal" class="modal">
    <div class="modal-content">
      <button onclick="fecharScanner()" class="modal-close">
        <i class="bi bi-x-lg"></i>
      </button>
      <div class="section-title" style="margin-bottom: 1rem;">
        <i class="bi bi-qr-code-scan"></i>
        Scanner QR Code
      </div>
      <div id="qr-reader" style="width: 100%; max-width: 300px;"></div>
    </div>
  </div>

  
  <script>
    // Sistema de Gerenciamento de M√∫ltiplas Inst√¢ncias
    class SessionManager {
      constructor() {
        this.currentSessionId = null;
        this.sessions = this.loadSessions();
        this.initializeSession();
      }

      generateSessionId() {
        const timestamp = Date.now();
        const random = Math.random().toString(36).substr(2, 5);
        return `CARR_${timestamp}_${random}`.toUpperCase();
      }

      initializeSession() {
        // Verifica se h√° uma sess√£o ativa no sessionStorage
        const activeSession = sessionStorage.getItem('activeSessionId');
        
        if (activeSession && this.sessions[activeSession]) {
          this.currentSessionId = activeSession;
        } else {
          // Cria nova sess√£o
          this.currentSessionId = this.generateSessionId();
          this.sessions[this.currentSessionId] = {
            id: this.currentSessionId,
            created: new Date().toISOString(),
            updated: new Date().toISOString(),
            status: 'new',
            data: {}
          };
          sessionStorage.setItem('activeSessionId', this.currentSessionId);
          this.saveSessions();
        }
        
        this.updateSessionDisplay();
        this.loadSessionData();
      }

      createNewSession() {
        const newId = this.generateSessionId();
        this.sessions[newId] = {
          id: newId,
          created: new Date().toISOString(),
          updated: new Date().toISOString(),
          status: 'new',
          data: {}
        };
        
        this.switchToSession(newId);
        return newId;
      }

      duplicateSession() {
        const currentData = this.getCurrentSessionData();
        const newId = this.generateSessionId();
        
        this.sessions[newId] = {
          id: newId,
          created: new Date().toISOString(),
          updated: new Date().toISOString(),
          status: 'new',
          data: { ...currentData }
        };
        
        this.switchToSession(newId);
        this.loadSessionData();
        return newId;
      }

      switchToSession(sessionId) {
        if (!this.sessions[sessionId]) return false;
        
        // Salva dados da sess√£o atual antes de trocar
        this.saveCurrentSession();
        
        this.currentSessionId = sessionId;
        sessionStorage.setItem('activeSessionId', sessionId);
        this.updateSessionDisplay();
        this.loadSessionData();
        return true;
      }

      saveCurrentSession() {
        if (!this.currentSessionId) return;
        
        const data = this.getCurrentSessionData();
        const status = this.determineStatus(data);
        
        this.sessions[this.currentSessionId] = {
          ...this.sessions[this.currentSessionId],
          updated: new Date().toISOString(),
          status: status,
          data: data
        };
        
        this.saveSessions();
      }

      getCurrentSessionData() {
  const data = {};
  
  // Coleta todos os dados do formul√°rio
  camposParaSalvar.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.type === 'checkbox') {
        data[id] = el.checked;
      } else {
        data[id] = el.value;
      }
    }
  });

  // Coleta dados dos checkboxes especiais
  data.lateral1NaoUsa = document.getElementById('lateral1NaoUsa')?.checked || false;
  data.lateral2NaoUsa = document.getElementById('lateral2NaoUsa')?.checked || false;

  // CORRIGIDO: Coleta rotas selecionadas com mais detalhes
  const rotasCheckboxes = document.querySelectorAll('#rotasCheckboxes input[type="checkbox"]');
data.rotasCheckboxes = Array.from(rotasCheckboxes)
  .filter(cb => cb.checked)
  .map(cb => cb.value);
  
  // ADICIONADO: Debug para verificar o que est√° sendo salvo
  console.log('Dados sendo salvos:', {
    nomeMotorista: data.nomeMotorista,
    rotasCount: Object.keys(data.rotasCheckboxes).length,
    rotasSelecionadas: Object.entries(data.rotasCheckboxes).filter(([id, checked]) => checked)
  });

  return data;
}

      loadSessionData() {
  if (!this.currentSessionId || !this.sessions[this.currentSessionId]) return;
  
  const sessionData = this.sessions[this.currentSessionId].data;
  
  console.log('Carregando dados da sess√£o:', sessionData); // Debug
  
  // Carrega dados b√°sicos
  camposParaSalvar.forEach(id => {
    const el = document.getElementById(id);
    if (el && sessionData[id] !== undefined) {
      if (el.type === 'checkbox') {
        el.checked = sessionData[id];
      } else {
        el.value = sessionData[id];
      }
    }
  });

  // Carrega checkboxes especiais
  if (sessionData.lateral1NaoUsa !== undefined) {
    document.getElementById('lateral1NaoUsa').checked = sessionData.lateral1NaoUsa;
  }
  if (sessionData.lateral2NaoUsa !== undefined) {
    document.getElementById('lateral2NaoUsa').checked = sessionData.lateral2NaoUsa;
  }

  // CORRIGIDO: Carrega rotas com verifica√ß√£o mais robusta
  if (sessionData.rotasCheckboxes) {
    console.log('Carregando rotas:', sessionData.rotasCheckboxes); // Debug
    
    // Se √© um objeto (novo formato)
    if (Array.isArray(sessionData.rotasCheckboxes)) {
  const rotasCheckboxes = document.querySelectorAll('#rotasCheckboxes input[type="checkbox"]');
  rotasCheckboxes.forEach(cb => {
    cb.checked = sessionData.rotasCheckboxes.includes(cb.value);
  });
}
  }
}

      determineStatus(data) {
        const hasBasicData = data.data || data.doca || data.nomeMotorista;
        const hasTimeData = data.horaChegada || data.horaInicio;
        const isComplete = data.horaSaida && data.lacreBau;
        
        if (isComplete) return 'completed';
        if (hasTimeData) return 'progress';
        if (hasBasicData) return 'new';
        return 'new';
      }

      deleteSession(sessionId) {
        if (sessionId === this.currentSessionId) {
          // Se est√° deletando a sess√£o atual, cria uma nova
          delete this.sessions[sessionId];
          this.createNewSession();
        } else {
          delete this.sessions[sessionId];
        }
        this.saveSessions();
      }

      loadSessions() {
        try {
          const saved = localStorage.getItem('carregamento_sessions');
          return saved ? JSON.parse(saved) : {};
        } catch (e) {
          console.error('Erro ao carregar sess√µes:', e);
          return {};
        }
      }

      saveSessions() {
        try {
          localStorage.setItem('carregamento_sessions', JSON.stringify(this.sessions));
        } catch (e) {
          console.error('Erro ao salvar sess√µes:', e);
        }
      }

      updateSessionDisplay() {
        const display = document.getElementById('current-session');
        if (display && this.currentSessionId) {
          const session = this.sessions[this.currentSessionId];
          const shortId = this.currentSessionId.split('_')[2] || this.currentSessionId.substr(-5);
          display.textContent = `Sess√£o: ${shortId}`;
          
          // Atualiza t√≠tulo da p√°gina
          document.title = `Carregamento MM - ${shortId}`;
        }
      }

      exportAllSessions() {
        const exportData = {
          exported: new Date().toISOString(),
          sessions: this.sessions
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `carregamento_sessions_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      importSessions(data) {
        try {
          if (data.sessions) {
            // Mescla com sess√µes existentes
            Object.assign(this.sessions, data.sessions);
            this.saveSessions();
            return true;
          }
        } catch (e) {
          console.error('Erro ao importar:', e);
        }
        return false;
      }

      getAllSessions() {
        return Object.values(this.sessions).sort((a, b) => 
          new Date(b.updated) - new Date(a.updated)
        );
      }
    }

    // Inst√¢ncia global do gerenciador
    let sessionManager;

    // Dados dos ve√≠culos (mantidos iguais)
    const placaMap = {
      "MSR - PQA8867 / JAE3D30": ["PQA8867", "JAE3D30"],
      "MSR - DRX8D24 / JAW3D30": ["DRX8D24", "JAW3D30"],
      "MSR - MXB3387 / MLO6F04": ["MXB3387", "MLO6F04"],
      "MSR - RBL4J23 / ONC3I65": ["RBL4J23", "ONC3I65"],
      "MSR - NWE5A88 / ONG5H07": ["NWE5A88", "ONG5H07"],

      "RODACOP - TCK5H69 / HDE8J16": ["TCK5H69", "HDE8J16"],
      "RODACOP - FOF5B57 / RUK2H11": ["FOF5B57", "RUK2H11"],
      "RODACOP - FTB1F75 / RUK2J60": ["FTB1F75", "RUK2J60"],

      "RODACOP - RVB1J25": ["", "RVB1J25"],
      "RODACOP - OFC7H98": ["", "OFC7H98"],
      "RODACOP - PVB0G08": ["", "PVB0G08"],
      "RODACOP - RUK9J07": ["", "RUK9J07"],

      "RODACOP - RVB2C09": ["", "RVB2C09"],
      "RODACOP - OQG8012": ["", "OQG8012"],
      "RODACOP - RFR7E89": ["", "RFR7E89"],
      "RODACOP - OLM1I23": ["", "OLM1I23"],
      "RODACOP - QKA6J98": ["", "QKA6J98"],
      "RODACOP - RSE9F12": ["", "RSE9F12"],
      "RODACOP - RIN8H85": ["", "RIN8H85"],
      "RODACOP - OLH2G94": ["", "OLH2G94"],


      "KIA5I83": ["", "KIA5I83"],
      "PRO5B99": ["", "PRO5B99"],
      "RMB6C84 - RMB6D04": ["RMB6C84", "RMB6D04"]

    };

    // Dados dos motoristas (mantidos iguais)
    const motoristas = [
      { nome: "Evaldo de Queiroz", cpf: "950.351.335-61", telefone: "63992640497" },
      { nome: "Raimundo Nonato", cpf: "", telefone: "63992754794" },
      { nome: "Jales Soares", cpf: "", telefone: "63993043424" },
      { nome: "Cleuton Mac√™do", cpf: "813.243.161-87", telefone: "63981439951" },
      { nome: "Tallysson Magno dos Santos", cpf: "", telefone: "63991169026" },
      { nome: "Marcos Vinicius Oliveira", cpf: "", telefone: "63992500932" },
      { nome: "Wanderson Oliveira Magalh√£es", cpf: "062.133.781-11", telefone: "" },
      { nome: "Lucas Nascimento Noleto", cpf: "053.257.531-85", telefone: "63992200657" },
      { nome: "Flacilde Fagundes", cpf: "010.746.931-67", telefone: "62981881286" },
      { nome: "Flavio Fagundes", cpf: "", telefone: "62992749714" },
      { nome: "Wellington Pereira da Silva", cpf: "", telefone: "63991279809" },
      { nome: "Gabriel Lopes Soares", cpf: "082.629.441-35", telefone: "63981588214" },
      { nome: "Air Ot√°vio C√¢ndido", cpf: "", telefone: "63999150105" },
      { nome: "Ronielton Alves de Oliveira", cpf: "026.150.421-57", telefone: "63984208575" },
      { nome: "Idamilton Andrade Silva", cpf: "023.474.221-62", telefone: "63981211457" },
      { nome: "Francis Aniszewski da Silva Gomes", cpf: "026.385.201-60", telefone: "63981013325" },
      { nome: "Savio de Souza Santos", cpf: "077.250.851-81", telefone: "63992735270" },
      { nome: "Dalvan dos Santos", cpf: "042.027.111-22", telefone: "63992363023" },
      { nome: "Geovanne Alex da Silva", cpf: "057.442.151-31", telefone: "" },
      { nome: "Divino Alves Guida", cpf: "027.865.341-35", telefone: "63999456665" },
      { nome: "Diego Alexandre Padovan", cpf: "", telefone: "11951442749" },
      { nome: "Railan Pereira Coelho dos Santos", cpf: "066.304.091-40", telefone: "63991223145" },
      { nome: "Romario Aleixo Lima", cpf: "040.701.101-35", telefone: "63992531915" },
      { nome: "Raul Monteiro de Sousa", cpf: "059.668.101-17", telefone: "63991091677" },
      { nome: "Caio Vinicius Oliveira da Silva", cpf: "603.210.033-22", telefone: "63992541607" },
      { nome: "Juan de Souza Ribeiro", cpf: "070.732.651-74", telefone: "63992817191" },
      { nome: "Bismael Rodrigues de Sousa Oliveira", cpf: "050.908.111-80", telefone: "63992446420" },
      { nome: "Wesley Gon√ßalves Rodrigues", cpf: "590.682.721-68", telefone: "63984014369" },
      { nome: "Odair Jos√© de Sousa", cpf: "989.477.611-68", telefone: "63984826152" },
      { nome: "Lu√≠s Eduardo Sales", cpf: "", telefone: "" },
      { nome: "Bruno Sobrinho", cpf: "", telefone: "" },
      { nome: "Rayllan Ribeiro", cpf: "", telefone: "" },
      { nome: "Kaique Ribeiro", cpf: "", telefone: "" },
      { nome: "Matheus Gomes", cpf: "", telefone: "" },
      { nome: "Alessandro Noleto", cpf: "", telefone: "" }
    ];

    // Campos para gerenciar
    const camposParaSalvar = [
      "data", "rota-select", "doca", "tipoVeiculo", "placaPrimaria", "placaSecundaria",
      "nomeMotorista", "telefoneMotorista", "cpfMotorista", "horaChegada", "horaDoca", 
      "horaInicio", "horaTermino", "horaSaida", "previsaoDestino", 
      "lacreBau", "lacreLateral1", "lacreLateral2", 
      "volumoso", "gaiola", "mangaPallet"
    ];

    // Vari√°veis globais para scanner
    let campoAtivo;
    let html5QrCode;
    let selectedSuggestionIndex = -1;

    // Fun√ß√µes de gerenciamento de inst√¢ncias
    function novaInstancia() {
      if (confirm('Criar nova inst√¢ncia de carregamento?')) {
        sessionManager.createNewSession();
        limparFormularioSemConfirmacao();
        alert('Nova inst√¢ncia criada com sucesso!');
      }
    }

    function duplicarInstancia() {
      if (confirm('Duplicar a inst√¢ncia atual com todos os dados?')) {
        sessionManager.duplicateSession();
        alert('Inst√¢ncia duplicada com sucesso!');
      }
    }

    function gerenciarInstancias() {
  sessionManager.saveCurrentSession();
  
  // ADICIONADO: Limpa sess√µes inv√°lidas antes de mostrar
  limparSessoesInvalidas();
  
  mostrarGerenciador();
}

    function salvarInstancia() {
      sessionManager.saveCurrentSession();
      
      // Feedback visual
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-check-circle"></i> Salvo!';
      btn.disabled = true;
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 2000);
    }

    function mostrarGerenciador() {
  const modal = document.getElementById('gerenciarModal');
  const sessionList = document.getElementById('session-list');
  
  sessionList.innerHTML = '';
  
  const sessions = sessionManager.getAllSessions();
  
  sessions.forEach(session => {
    // CORRE√á√ÉO: Verifica se a sess√£o e o ID existem
    if (!session || !session.id) {
      console.warn('Sess√£o inv√°lida encontrada:', session);
      return; // Pula esta sess√£o
    }
    
    const div = document.createElement('div');
    div.className = `session-item ${session.id === sessionManager.currentSessionId ? 'active' : ''}`;
    
    // CORRE√á√ÉO: Tratamento mais seguro para extrair ID curto
    let shortId;
    try {
      const parts = session.id.split('_');
      shortId = parts.length > 2 ? parts[2] : session.id.substr(-5);
    } catch (error) {
      console.error('Erro ao processar ID da sess√£o:', session.id, error);
      shortId = 'ID-ERRO';
    }
    
    // CORRE√á√ÉO: Verifica se as datas existem antes de processar
    const createdDate = session.created ? new Date(session.created).toLocaleString('pt-BR') : 'Data n√£o dispon√≠vel';
    const updatedDate = session.updated ? new Date(session.updated).toLocaleString('pt-BR') : 'Data n√£o dispon√≠vel';
    
    // CORRE√á√ÉO: Verifica se session.data existe antes de acessar propriedades
    const sessionData = session.data || {};
    const info = [];
    if (sessionData['rota-select']) info.push(`Rota: ${sessionData['rota-select']}`);
    if (sessionData.nomeMotorista) info.push(`Motorista: ${sessionData.nomeMotorista}`);
    if (sessionData.placaPrimaria) info.push(`Placa: ${sessionData.placaPrimaria}`);
    if (sessionData.data) {
      const dataFormatada = sessionData.data.split('-').reverse().join('/');
      info.push(`Data: ${dataFormatada}`);
    }
    
    const statusClass = {
      'new': 'status-new',
      'progress': 'status-progress', 
      'completed': 'status-completed'
    }[session.status] || 'status-new';
    
    div.innerHTML = `
      <div class="session-item-header">
        <div class="session-item-id">
          <span class="status-indicator ${statusClass}"></span>
          ${shortId}
        </div>
        <div class="session-item-actions">
          <button onclick="alternarSessao('${session.id}')" class="btn btn-primary btn-small">
            ${session.id === sessionManager.currentSessionId ? 'Atual' : 'Abrir'}
          </button>
          ${session.id !== sessionManager.currentSessionId ? 
            `<button onclick="excluirSessao('${session.id}')" class="btn btn-danger btn-small">
              <i class="bi bi-trash"></i>
            </button>` : ''
          }
        </div>
      </div>
      <div class="session-item-info">
        <div>Criado: ${createdDate}</div>
        <div>Atualizado: ${updatedDate}</div>
        ${info.length > 0 ? `<div>${info.join(' ‚Ä¢ ')}</div>` : ''}
      </div>
    `;
    
    sessionList.appendChild(div);
  });
  
  modal.style.display = 'flex';
}

    function alternarSessao(sessionId) {
      if (sessionManager.switchToSession(sessionId)) {
        fecharGerenciar();
        alert('Sess√£o alterada com sucesso!');
      }
    }

    function excluirSessao(sessionId) {
      const session = sessionManager.sessions[sessionId];
      const shortId = session.id.split('_')[2] || session.id.substr(-5);
      
      if (confirm(`Excluir permanentemente a sess√£o ${shortId}?`)) {
        sessionManager.deleteSession(sessionId);
        mostrarGerenciador(); // Atualiza a lista
      }
    }

    function fecharGerenciar() {
      document.getElementById('gerenciarModal').style.display = 'none';
    }

    function exportarTodas() {
      sessionManager.exportAllSessions();
    }

    function importarSessoes() {
      document.getElementById('fileImport').click();
    }

    function excluirTodasSessoes() {
  const totalSessoes = Object.keys(sessionManager.sessions).length;
  
  if (totalSessoes === 0) {
    alert('N√£o h√° sess√µes para excluir.');
    return;
  }
  
  const confirmacao = confirm(
    `‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° excluir TODAS as ${totalSessoes} sess√µes permanentemente!\n\n` +
    `Esta a√ß√£o N√ÉO pode ser desfeita.\n\n` +
    `Tem certeza que deseja continuar?`
  );
  
  if (!confirmacao) return;
  
  // Confirma√ß√£o adicional
  const confirmacaoFinal = confirm(
    `üö® √öLTIMA CONFIRMA√á√ÉO!\n\n` +
    `Voc√™ est√° prestes a excluir todas as sess√µes.\n` +
    `Clique OK para CONFIRMAR a exclus√£o definitiva.`
  );
  
  if (!confirmacaoFinal) return;
  
  try {
    // Limpa todas as sess√µes
    sessionManager.sessions = {};
    sessionManager.saveSessions();
    
    // Remove a sess√£o ativa do sessionStorage
    sessionStorage.removeItem('activeSessionId');
    
    // Cria uma nova sess√£o
    sessionManager.createNewSession();
    
    // Limpa o formul√°rio
    limparFormularioSemConfirmacao();
    
    // Fecha o modal e mostra confirma√ß√£o
    fecharGerenciar();
    alert('‚úÖ Todas as sess√µes foram exclu√≠das com sucesso!\nUma nova sess√£o foi criada.');
    
  } catch (error) {
    console.error('Erro ao excluir sess√µes:', error);
    alert('‚ùå Erro ao excluir sess√µes. Tente novamente.');
  }
}

  // NOVA FUN√á√ÉO: Limpa sess√µes corrompidas
function limparSessoesInvalidas() {
  let sessoesLimpas = false;
  const sessoesValidas = {};
  
  Object.entries(sessionManager.sessions).forEach(([id, session]) => {
    // Verifica se a sess√£o tem estrutura m√≠nima v√°lida
    if (session && session.id && typeof session.id === 'string') {
      sessoesValidas[id] = session;
    } else {
      console.warn('Sess√£o inv√°lida removida:', id, session);
      sessoesLimpas = true;
    }
  });
  
  if (sessoesLimpas) {
    sessionManager.sessions = sessoesValidas;
    sessionManager.saveSessions();
    console.log('Sess√µes inv√°lidas foram removidas');
    return true;
  }
  
  return false;
}

    function processarImportacao(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (sessionManager.importSessions(data)) {
            alert('Sess√µes importadas com sucesso!');
            mostrarGerenciador();
          } else {
            alert('Erro ao importar arquivo. Verifique o formato.');
          }
        } catch (error) {
          alert('Arquivo inv√°lido.');
        }
      };
      reader.readAsText(file);
      input.value = ''; // Limpa o input
    }

    // Fun√ß√µes originais adaptadas
    function inserirData() {
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data').value = hoje;
      sessionManager.saveCurrentSession();
    }

    function verificarTipoVeiculo() {
      const tipo = document.getElementById('tipoVeiculo').value;
      sessionManager.saveCurrentSession();
    }

    function onSelectChange(select) {
      const selected = select.value;
      const manual = selected === "manual";

      document.getElementById("placaPrimaria").disabled = !manual;
      document.getElementById("placaSecundaria").disabled = !manual;

      if (!manual && placaMap[selected]) {
        const [primaria, secundaria] = placaMap[selected];
        document.getElementById("placaPrimaria").value = primaria;
        document.getElementById("placaSecundaria").value = secundaria;
      } else {
        document.getElementById("placaPrimaria").value = "";
        document.getElementById("placaSecundaria").value = "";
      }
      
      sessionManager.saveCurrentSession();
    }

    // Fun√ß√£o de autocomplete adaptada
    function setupAutocomplete() {
  const input = document.getElementById('nomeMotorista');
  const suggestionsDiv = document.getElementById('suggestions');
  
  input.addEventListener('input', function() {
    const value = this.value.toLowerCase();
    const filteredMotoristas = motoristas.filter(motorista => 
      motorista.nome.toLowerCase().includes(value)
    );
    
    // ADICIONADO: Auto-save quando o usu√°rio digita
    sessionManager.saveCurrentSession();
    
    if (value === '' || filteredMotoristas.length === 0) {
      suggestionsDiv.style.display = 'none';
      selectedSuggestionIndex = -1;
      return;
    }
    
    suggestionsDiv.innerHTML = '';
    filteredMotoristas.forEach((motorista, index) => {
      const div = document.createElement('div');
      div.className = 'autocomplete-suggestion';
      div.textContent = motorista.nome;
      div.addEventListener('click', () => selectMotorista(motorista));
      suggestionsDiv.appendChild(div);
    });
    
    suggestionsDiv.style.display = 'block';
    selectedSuggestionIndex = -1;
  });
  
  // ADICIONADO: Salva quando o campo perde o foco
  input.addEventListener('blur', function() {
    setTimeout(() => {
      sessionManager.saveCurrentSession();
    }, 300); // Delay para permitir clique nas sugest√µes
  });
  
  input.addEventListener('keydown', function(e) {
    const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
      updateSelectedSuggestion(suggestions);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
      updateSelectedSuggestion(suggestions);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedSuggestionIndex >= 0 && suggestions[selectedSuggestionIndex]) {
        const motoristaNome = suggestions[selectedSuggestionIndex].textContent;
        const motorista = motoristas.find(m => m.nome === motoristaNome);
        if (motorista) selectMotorista(motorista);
      }
    } else if (e.key === 'Escape') {
      suggestionsDiv.style.display = 'none';
      selectedSuggestionIndex = -1;
    }
  });
  
  document.addEventListener('click', function(e) {
    if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = 'none';
      selectedSuggestionIndex = -1;
    }
  });
}
    
    function updateSelectedSuggestion(suggestions) {
      suggestions.forEach((suggestion, index) => {
        suggestion.classList.toggle('selected', index === selectedSuggestionIndex);
      });
    }
    
    function selectMotorista(motorista) {
      document.getElementById('nomeMotorista').value = motorista.nome;
      document.getElementById('telefoneMotorista').value = motorista.telefone;
      document.getElementById('cpfMotorista').value = motorista.cpf;
      document.getElementById('suggestions').style.display = 'none';
      selectedSuggestionIndex = -1;
      
      sessionManager.saveCurrentSession();
    }

    function registrarHoraComConfirmacao(id) {
      const input = document.getElementById(id);
      if (input.value) {
        const confirmar = confirm("Hor√°rio j√° registrado: \"" + input.value + "\". Deseja ajustar?");
        if (!confirmar) return;
      }
      registrarHora(id);
    }

    function registrarHora(id) {
      const agora = new Date();
      const hora = agora.toTimeString().split(":").slice(0, 2).join(":");
      document.getElementById(id).value = hora;
      
      const input = document.getElementById(id);
      input.classList.add('scanning');
      setTimeout(() => input.classList.remove('scanning'), 1000);
      
      sessionManager.saveCurrentSession();
    }

    function confirmarFotoBauAberto() {
      if (confirm("Tirar foto do ba√∫ aberto!")) {
        registrarHora('horaTermino');
      }
    }

    function alterarContagem(id, delta) {
      const input = document.getElementById(id);
      let val = parseInt(input.value);
      if (!isNaN(val)) {
        val += delta;
        if (val < 0) val = 0;
        input.value = val;
        sessionManager.saveCurrentSession();
      }
    }

    function gerarCheckboxesRotas() {
  const container = document.getElementById('rotasCheckboxes');
  for (let i = 1; i <= 80; i++) {
    const div = document.createElement('div');
    div.className = 'checkbox-item';
    div.innerHTML = `
      <input type="checkbox" id="rota${i}" value="${i.toString().padStart(2, '0')}">
      <label for="rota${i}">${i.toString().padStart(2, '0')}</label>
    `;
    container.appendChild(div);
  }
  
  // CORRIGIDO: Adiciona eventos imediatamente ap√≥s criar os checkboxes
  const checkboxes = document.querySelectorAll('#rotasCheckboxes input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      console.log('Checkbox rota alterado:', cb.id, cb.checked); // Debug
      sessionManager.saveCurrentSession();
    });
  });
}

    function scanQRCode(campoId) {
      campoAtivo = document.getElementById(campoId);
      document.getElementById("qrScannerModal").style.display = "flex";

      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("qr-reader");
      }

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          let cameraId;
          const backCamera = cameras.find(cam =>
            cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("traseira")
          );

          if (backCamera) {
            cameraId = backCamera.id;
          } else {
            cameraId = cameras[0].id;
          }

          html5QrCode.start(
            cameraId,
            {
              fps: 10,
              qrbox: 250
            },
            (decodedText, decodedResult) => {
              campoAtivo.value = decodedText;
              sessionManager.saveCurrentSession();
              html5QrCode.stop().then(() => {
                fecharScanner();
              }).catch(err => {
                console.error("Erro ao parar o scanner:", err);
                fecharScanner();
              });
            }
          ).catch(err => {
            alert("Erro ao iniciar a c√¢mera: " + err);
            fecharScanner();
          });
        } else {
          alert("Nenhuma c√¢mera encontrada.");
          fecharScanner();
        }
      }).catch(err => {
        alert("Erro ao acessar c√¢mera: " + err);
        fecharScanner();
      });
    }

    function fecharScanner() {
      document.getElementById("qrScannerModal").style.display = "none";
      if (html5QrCode && html5QrCode._isScanning) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
        }).catch(err => {
          console.warn("Erro ao parar scanner:", err);
        });
      } else {
        document.getElementById("qr-reader").innerHTML = "";
      }
    }

    function gerarReport() {
      if (!confirm("Tem certeza que deseja gerar o relat√≥rio?")) return;

      // Salva antes de gerar o relat√≥rio
      sessionManager.saveCurrentSession();

      const dataInput = document.getElementById('data')?.value;
      const data = dataInput ? dataInput.split('-').reverse().join('/') : '';
      const doca = document.getElementById('doca')?.value;
      const rota = document.getElementById('rota-select')?.value;
      const tipoVeiculo = document.getElementById('tipoVeiculo')?.value;
      const placaPrimaria = document.getElementById('placaPrimaria')?.value;
      const placaSecundaria = document.getElementById('placaSecundaria')?.value;
      const motorista = document.getElementById('nomeMotorista')?.value;
      const cpf = document.getElementById('cpfMotorista')?.value;
      const telefone = document.getElementById('telefoneMotorista')?.value;
      const horaChegada = document.getElementById('horaChegada')?.value;
      const horaDoca = document.getElementById('horaDoca')?.value;
      const horaInicio = document.getElementById('horaInicio')?.value;
      const horaTermino = document.getElementById('horaTermino')?.value;
      const horaSaida = document.getElementById('horaSaida')?.value;
      const previsaoDestino = document.getElementById('previsaoDestino')?.value;
      const lacreBau = document.getElementById('lacreBau')?.value;
      const lacreLateral1 = document.getElementById('lacreLateral1')?.value || (document.getElementById('lateral1NaoUsa')?.checked ? 'N√£o Utiliza' : '');
      const lacreLateral2 = document.getElementById('lacreLateral2')?.value || (document.getElementById('lateral2NaoUsa')?.checked ? 'N√£o Utiliza' : '');
      const volumoso = document.getElementById('volumoso')?.value;
      const gaiola = document.getElementById('gaiola')?.value;
      const mangaPallet = document.getElementById('mangaPallet')?.value;
      const rotasSelecionadas = Array.from(document.querySelectorAll('#rotasCheckboxes input[type="checkbox"]:checked'))
        .map(cb => cb.value)
        .join(', ');

      const shortId = sessionManager.currentSessionId.split('_')[2] || sessionManager.currentSessionId.substr(-5);

      const mensagem = `RELAT√ìRIO DE CARREGAMENTO MM
Sess√£o: ${shortId}

Data: ${data}
Doca: ${doca}
${tipoVeiculo}: ${rota}
Placa: ${placaSecundaria}
Placa Cavalo: ${placaPrimaria}
Condutor: ${motorista}
CPF: ${cpf}
Tel: ${telefone}
Chegada na unidade: ${horaChegada}
Encostado na doca: ${horaDoca}
In√≠cio carregamento: ${horaInicio}
T√©rmino: ${horaTermino}
Sa√≠da Liberada: ${horaSaida}
Previs√£o do Destino: ${previsaoDestino}
Gaiolas: ${gaiola}
Rotas: ${rotasSelecionadas}
Lacre Ba√∫: ${lacreBau}
Lacres Laterais: ${lacreLateral1} || ${lacreLateral2}
Manga Pallet com sacolas: ${mangaPallet}
Volumosos: ${volumoso}
Yms sa√≠da ok...........`;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);

      const margemEsquerda = 10;
      const larguraMaxima = 190; 
      let y = 10;

      const linhas = mensagem.split('\n');

      linhas.forEach(linha => {
        const linhasQuebradas = doc.splitTextToSize(linha, larguraMaxima);
        linhasQuebradas.forEach(subLinha => {
          if (y > 280) { 
            doc.addPage();
            y = 10;
          }
          doc.text(subLinha, margemEsquerda, y);
          y += 8;
        });
      });

      doc.save(`carregamento-${shortId}-${data.replace(/\//g, '-')}.pdf`);
    }

    function limparFormulario() {
      if (!confirm("Tem certeza que deseja limpar todos os dados da sess√£o atual?")) return;
      limparFormularioSemConfirmacao();
    }

    function limparFormularioSemConfirmacao() {
      document.getElementById("form-carregamento").reset();

      ["placaPrimaria", "placaSecundaria", "nomeMotorista", "telefoneMotorista", "cpfMotorista", "previsaoDestino"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });

      document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
      ["volumoso", "gaiola", "mangaPallet"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = 0;
      });

      // Limpa dados da sess√£o atual
      sessionManager.sessions[sessionManager.currentSessionId].data = {};
      sessionManager.saveCurrentSession();
    }

    // Auto-save em mudan√ßas
    function setupAutoSave() {
      // Eventos para campos de input
      camposParaSalvar.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        
        const evento = el.tagName === "INPUT" || el.tagName === "TEXTAREA" ? "input" : "change";
        el.addEventListener(evento, () => {
          // Pequeno delay para evitar muitas grava√ß√µes
          clearTimeout(window.autoSaveTimeout);
          window.autoSaveTimeout = setTimeout(() => {
            sessionManager.saveCurrentSession();
          }, 500);
        });
      });

      // Eventos para checkboxes especiais
      ['lateral1NaoUsa', 'lateral2NaoUsa'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', () => sessionManager.saveCurrentSession());
        }
      });
    }

    // Auto-save antes de sair da p√°gina
    window.addEventListener('beforeunload', (e) => {
      if (sessionManager) {
        sessionManager.saveCurrentSession();
      }
    });

    // Inicializa√ß√£o
    window.addEventListener("load", () => {
  // Inicializa o gerenciador de sess√µes
  sessionManager = new SessionManager();
  
  // Configura a interface
  gerarCheckboxesRotas(); // Gera os checkboxes PRIMEIRO
  setupAutocomplete();
  setupAutoSave();
  
  console.log('Sistema inicializado. Sess√£o atual:', sessionManager.currentSessionId);
});

    // Teclas de atalho
    document.addEventListener('keydown', (e) => {
      // Ctrl + N: Nova inst√¢ncia
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        novaInstancia();
      }
      
      // Ctrl + S: Salvar
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        salvarInstancia();
      }
      
      // Ctrl + G: Gerenciar
      if (e.ctrlKey && e.key === 'g') {
        e.preventDefault();
        gerenciarInstancias();
      }
    });

 function gerarReportConsolidado() {
      const modal = document.getElementById('reportConsolidadoModal');
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    function fecharReportConsolidado() {
      const modal = document.getElementById('reportConsolidadoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
// FUN√á√ÉO DE GERAR O REPORT CONSOLIDADO DO DIA

const codigosXPT = {
  "Aragua√≠na": "XPT ETO2",
  "Gurupi": "XPT ETO1", 
  "Guara√≠": "XPT ETO3",
  "Luiz Eduardo Magalh√£es": "XPT EBA8",
  "Barreiras": "XPT EBA24"
};

function gerarReportConsolidado() {
  const modal = document.getElementById('reportConsolidadoModal');
  if (modal) {
    // Define data atual como padr√£o
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('dataReportConsolidado').value = hoje;
    modal.style.display = 'flex';
  }
}

function fecharReportConsolidado() {
  const modal = document.getElementById('reportConsolidadoModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

function processarReportConsolidado() {
  console.log('üîÑ Iniciando processamento do report consolidado...');
  
  const data = document.getElementById('dataReportConsolidado').value;
  const rota = document.getElementById('rotaReportConsolidado').value;
  
  // Valida√ß√£o b√°sica
  if (!data || !rota) {
    alert('‚ö†Ô∏è Por favor, selecione a data e a rota!');
    return;
  }
  
  console.log('üìÖ Data selecionada:', data);
  console.log('üöõ Rota selecionada:', rota);
  
  // Busca as sess√µes
  const resultado = gerarDadosReportConsolidado(data, rota);
  
  if (resultado.sucesso) {
    // Copia para √°rea de transfer√™ncia e mostra o resultado
    copiarParaAreaTransferencia(resultado.texto)
      .then(() => {
        alert(`‚úÖ Report consolidado copiado para √°rea de transfer√™ncia!\n\n${resultado.resumo}`);
        fecharReportConsolidado();
      })
      .catch(() => {
        // Fallback: mostra em alert se n√£o conseguir copiar
        alert(`üìã Report Consolidado:\n\n${resultado.texto}\n\n${resultado.resumo}`);
        fecharReportConsolidado();
      });
  }
}

function gerarDadosReportConsolidado(data, rota) {
  console.log('üîç Buscando sess√µes no sistema...');
  
  // Busca todas as sess√µes salvas
  let todasSessoes = {};
  
  try {
    // Primeiro tenta carregar do localStorage
    const dadosSalvos = localStorage.getItem('carregamento_sessions');
    if (dadosSalvos) {
      todasSessoes = JSON.parse(dadosSalvos);
      console.log('üíæ Sess√µes encontradas no localStorage:', Object.keys(todasSessoes).length);
    }
    
    // Se n√£o encontrou ou est√° vazio, tenta usar o sessionManager
    if (Object.keys(todasSessoes).length === 0 && window.sessionManager && sessionManager.sessions) {
      // For√ßa salvamento das sess√µes atuais
      sessionManager.saveSessions();
      todasSessoes = sessionManager.sessions;
      console.log('üíæ Usando sess√µes do sessionManager:', Object.keys(todasSessoes).length);
    }
    
  } catch (error) {
    console.error('‚ùå Erro ao ler dados:', error);
  }
  
  // Verifica se encontrou sess√µes
  if (Object.keys(todasSessoes).length === 0) {
    alert('‚ùå Nenhuma sess√£o encontrada no sistema!\n\nCertifique-se de que voc√™ salvou algumas sess√µes primeiro usando o bot√£o "Salvar Sess√£o".');
    return { sucesso: false };
  }
  
  console.log('üîç Total de sess√µes no sistema:', Object.keys(todasSessoes).length);
  
  // Filtra as sess√µes que coincidem com data e rota
  const sessoesEncontradas = [];
  const dataFormatada = data; // Formato YYYY-MM-DD
  
  console.log('üéØ Filtrando por data:', dataFormatada, 'e rota:', rota);
  
  Object.values(todasSessoes).forEach((sessao, index) => {
    if (!sessao || !sessao.data) {
      console.log(`‚ö†Ô∏è Sess√£o ${index} sem dados v√°lidos`);
      return;
    }
    
    const dados = sessao.data;
    const dataSession = dados.data ? dados.data.trim() : '';
    const rotaSession = dados['rota-select'] ? dados['rota-select'].trim() : '';
    
    console.log(`üîç Sess√£o ${sessao.id ? sessao.id.substr(-8) : index}:`, {
      data: dataSession,
      rota: rotaSession,
      match: dataSession === dataFormatada && rotaSession === rota
    });
    
    if (dataSession === dataFormatada && rotaSession === rota) {
      sessoesEncontradas.push(sessao);
      console.log(`‚úÖ Sess√£o adicionada: ${sessao.id ? sessao.id.substr(-8) : index}`);
    }
  });
  
  console.log(`üìä Sess√µes encontradas para o filtro: ${sessoesEncontradas.length}`);
  
  // Se n√£o encontrou nenhuma sess√£o
  if (sessoesEncontradas.length === 0) {
    // Mostra dados dispon√≠veis para debug
    const datasDisponiveis = [...new Set(
      Object.values(todasSessoes)
        .map(s => s.data?.data)
        .filter(d => d)
    )].sort();
    
    const rotasDisponiveis = [...new Set(
      Object.values(todasSessoes)
        .map(s => s.data?.['rota-select'])
        .filter(r => r)
    )].sort();
    
    let mensagem = `‚ùå Nenhuma sess√£o encontrada para:\n`;
    mensagem += `üìÖ Data: ${data}\n`;
    mensagem += `üöõ Rota: ${rota}\n\n`;
    mensagem += `üìä Dados dispon√≠veis no sistema:\n`;
    mensagem += `üìÖ Datas: ${datasDisponiveis.join(', ') || 'Nenhuma'}\n`;
    mensagem += `üöõ Rotas: ${rotasDisponiveis.join(', ') || 'Nenhuma'}\n`;
    mensagem += `üíæ Total de sess√µes: ${Object.keys(todasSessoes).length}`;
    
    alert(mensagem);
    return { sucesso: false };
  }
  
  // Calcula os totais
  let totalCarros = sessoesEncontradas.length;
  let totalVolumosoItens = 0;
  let totalGaiolaItens = 0;
  let totalMangaPalletItens = 0;
  
  console.log('üßÆ Calculando totais para', sessoesEncontradas.length, 'sess√µes:');
  
  sessoesEncontradas.forEach((sessao, index) => {
    const dados = sessao.data || {};
    
    const volumoso = parseInt(dados.volumoso) || 0;
    const gaiola = parseInt(dados.gaiola) || 0;
    const mangaPallet = parseInt(dados.mangaPallet) || 0;
    
    console.log(`  üì¶ Sess√£o ${index + 1}:`, {
      volumoso: volumoso,
      gaiola: gaiola,
      mangaPallet: mangaPallet,
      motorista: dados.nomeMotorista || 'N/I'
    });
    
    totalVolumosoItens += volumoso;
    totalGaiolaItens += gaiola;
    totalMangaPalletItens += mangaPallet;
  });
  
  console.log('üìà Totais finais:', {
    carros: totalCarros,
    volumosos: totalVolumosoItens,
    gaiolas: totalGaiolaItens,
    mangaPallet: totalMangaPalletItens
  });
  
  // Gera o c√≥digo XPT
  const codigoXPT = codigosXPT[rota] || `XPT ${rota.substring(0, 3).toUpperCase()}`;
  
  // Formata a data para exibi√ß√£o (DD/MM/YYYY)
  const dataExibicao = data.split('-').reverse().join('/');
  
  // Monta o texto do relat√≥rio
  const textoReport = `REPORT DE CARREGAMENTO üööüöõüì¶
${codigoXPT} ${rota} - ${dataExibicao}

Quantidade de Carros: ${totalCarros.toString().padStart(2, '0')}
Quantidade de Volumoso: ${totalVolumosoItens.toString().padStart(2, '0')}
Quantidade de Gaiolas: ${totalGaiolaItens.toString().padStart(2, '0')}
Quantidade de manga de sacola: ${totalMangaPalletItens.toString().padStart(2, '0')}`;
  
  const resumo = `üìä Resumo: ${totalCarros} carros processados para ${rota} em ${dataExibicao}`;
  
  console.log('‚úÖ Report consolidado gerado com sucesso!');
  
  return {
    sucesso: true,
    texto: textoReport,
    resumo: resumo,
    data: data,
    rota: rota,
    totalCarros: totalCarros,
    totalVolumosoItens: totalVolumosoItens,
    totalGaiolaItens: totalGaiolaItens,
    totalMangaPalletItens: totalMangaPalletItens
  };
}

// Fun√ß√£o auxiliar para copiar texto para √°rea de transfer√™ncia
async function copiarParaAreaTransferencia(texto) {
  try {
    if (navigator.clipboard && window.isSecureContext) {
      // Usa a API moderna de clipboard
      await navigator.clipboard.writeText(texto);
      console.log('‚úÖ Texto copiado usando Clipboard API');
      return true;
    } else {
      // Fallback para navegadores mais antigos
      const textArea = document.createElement('textarea');
      textArea.value = texto;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.select();
      
      const sucesso = document.execCommand('copy');
      document.body.removeChild(textArea);
      
      if (sucesso) {
        console.log('‚úÖ Texto copiado usando execCommand');
        return true;
      } else {
        throw new Error('execCommand falhou');
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao copiar:', error);
    throw error;
  }
}

// Fun√ß√£o para debug - testar o report
function testarReportConsolidado() {
  console.log('üß™ Testando gera√ß√£o de report...');
  
  // Define valores de teste
  const hoje = new Date().toISOString().split('T')[0];
  document.getElementById('dataReportConsolidado').value = hoje;
  document.getElementById('rotaReportConsolidado').value = 'Aragua√≠na';
  
  // For√ßa salvamento da sess√£o atual para teste
  if (window.sessionManager) {
    sessionManager.saveCurrentSession();
  }
  
  // Executa o processamento
  processarReportConsolidado();
}

// Fun√ß√£o para listar todas as sess√µes (debug)
function listarTodasSessoes() {
  console.log('üìã === LISTAGEM DE TODAS AS SESS√ïES ===');
  
  let todasSessoes = {};
  
  try {
    const dadosSalvos = localStorage.getItem('carregamento_sessions');
    if (dadosSalvos) {
      todasSessoes = JSON.parse(dadosSalvos);
    }
    
    if (Object.keys(todasSessoes).length === 0 && window.sessionManager) {
      todasSessoes = sessionManager.sessions;
    }
    
    console.log(`üìä Total: ${Object.keys(todasSessoes).length} sess√µes`);
    
    Object.values(todasSessoes).forEach((sessao, index) => {
      const dados = sessao.data || {};
      console.log(`üìù ${index + 1}. ${sessao.id ? sessao.id.substr(-8) : 'ID-N/A'}:`, {
        data: dados.data || 'N/I',
        rota: dados['rota-select'] || 'N/I',
        motorista: dados.nomeMotorista || 'N/I',
        status: sessao.status || 'N/I'
      });
    });
    
  } catch (error) {
    console.error('‚ùå Erro ao listar sess√µes:', error);
  }
  
  console.log('üìã === FIM DA LISTAGEM ===');
}

// ========== SISTEMA DE LOGIN PIN ==========

// Configura√ß√£o do PIN (altere aqui para mudar o PIN)
const PIN_CORRETO = '0175'; // ‚ö†Ô∏è ALTERE ESTE PIN PARA SUA SEGURAN√áA!
const TEMPO_SESSAO = 8 * 60 * 60 * 1000; // 8 horas em milissegundos

// Elementos da interface de login
const loginOverlay = document.getElementById('loginOverlay');
const pinInputs = document.querySelectorAll('.pin-digit');
const btnEntrar = document.getElementById('btnEntrar');
const btnLimpar = document.getElementById('btnLimpar');
const errorMessage = document.getElementById('errorMessage');

// Vari√°veis de controle
let tentativasErradas = 0;
const MAX_TENTATIVAS = 3;
let bloqueado = false;

// Inicializa√ß√£o do sistema de login
function inicializarLogin() {
  // Verifica se j√° est√° autenticado
  if (verificarAutenticacao()) {
    ocultarLogin();
  } else {
    mostrarLogin();
  }
  
  // Configura eventos dos inputs PIN
  configurarEventosPIN();
  
  // Configura bot√µes
  btnEntrar.addEventListener('click', tentarLogin);
  btnLimpar.addEventListener('click', limparPIN);
  
  // Foco autom√°tico no primeiro campo
  setTimeout(() => {
    if (loginOverlay.style.display !== 'none') {
      pinInputs[0].focus();
    }
  }, 500);
}

// Configura eventos dos campos PIN
function configurarEventosPIN() {
  pinInputs.forEach((input, index) => {
    // Permite apenas n√∫meros
    input.addEventListener('input', (e) => {
      const valor = e.target.value.replace(/[^0-9]/g, '');
      e.target.value = valor;
      
      // Atualiza apar√™ncia
      if (valor) {
        e.target.classList.add('filled');
        // Move para pr√≥ximo campo
        if (index < pinInputs.length - 1) {
          pinInputs[index + 1].focus();
        }
      } else {
        e.target.classList.remove('filled');
      }
      
      // Remove classes de erro
      e.target.classList.remove('error');
      esconderErro();
      
      // Verifica se pode habilitar bot√£o
      atualizarBotaoEntrar();
    });
    
    // Navega√ß√£o com teclas
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        pinInputs[index - 1].focus();
        pinInputs[index - 1].value = '';
        pinInputs[index - 1].classList.remove('filled');
      }
      
      if (e.key === 'Enter') {
        e.preventDefault();
        if (btnEntrar.disabled === false) {
          tentarLogin();
        }
      }
      
      // Setas para navega√ß√£o
      if (e.key === 'ArrowLeft' && index > 0) {
        pinInputs[index - 1].focus();
      }
      if (e.key === 'ArrowRight' && index < pinInputs.length - 1) {
        pinInputs[index + 1].focus();
      }
    });
    
    // Seleciona tudo ao focar
    input.addEventListener('focus', (e) => {
      setTimeout(() => e.target.select(), 10);
    });
  });
}

// Verifica se todos os campos PIN est√£o preenchidos
function todosCamposPreenchidos() {
  return Array.from(pinInputs).every(input => input.value.length === 1);
}

// Atualiza estado do bot√£o entrar
function atualizarBotaoEntrar() {
  btnEntrar.disabled = !todosCamposPreenchidos() || bloqueado;
}

// Obter PIN digitado
function obterPINDigitado() {
  return Array.from(pinInputs).map(input => input.value).join('');
}

// Limpar campos PIN
function limparPIN() {
  pinInputs.forEach(input => {
    input.value = '';
    input.classList.remove('filled', 'error');
  });
  pinInputs[0].focus();
  esconderErro();
  atualizarBotaoEntrar();
}

// Mostrar erro
function mostrarErro(mensagem) {
  errorMessage.textContent = mensagem;
  errorMessage.classList.add('show');
  
  // Adiciona classe de erro aos campos
  pinInputs.forEach(input => {
    input.classList.add('error');
  });
}

// Esconder erro
function esconderErro() {
  errorMessage.classList.remove('show');
  pinInputs.forEach(input => {
    input.classList.remove('error');
  });
}

// Tentativa de login
function tentarLogin() {
  if (bloqueado) {
    mostrarErro('üö´ Sistema temporariamente bloqueado!');
    return;
  }
  
  const pinDigitado = obterPINDigitado();
  
  if (pinDigitado === PIN_CORRETO) {
    // Login bem-sucedido
    autenticarUsuario();
    ocultarLogin();
    
    // Feedback visual de sucesso
    pinInputs.forEach(input => {
      input.style.borderColor = '#28a745';
      input.style.boxShadow = '0 0 15px rgba(40, 167, 69, 0.5)';
    });
    
    setTimeout(() => {
      limparPIN();
    }, 1000);
    
  } else {
    // Login incorreto
    tentativasErradas++;
    
    if (tentativasErradas >= MAX_TENTATIVAS) {
      bloquearSistema();
    } else {
      const tentativasRestantes = MAX_TENTATIVAS - tentativasErradas;
      mostrarErro(`‚ùå PIN incorreto! ${tentativasRestantes} tentativa(s) restante(s).`);
      
      // Limpa PIN ap√≥s erro
      setTimeout(() => {
        limparPIN();
      }, 1500);
    }
  }
}

// Bloquear sistema temporariamente
function bloquearSistema() {
  bloqueado = true;
  const TEMPO_BLOQUEIO = 5 * 60 * 1000; // 5 minutos
  
  mostrarErro('üö´ Muitas tentativas incorretas! Sistema bloqueado por 5 minutos.');
  
  // Desabilita todos os controles
  pinInputs.forEach(input => {
    input.disabled = true;
    input.classList.add('error');
  });
  btnEntrar.disabled = true;
  btnLimpar.disabled = true;
  
  // Reabilita ap√≥s tempo de bloqueio
  setTimeout(() => {
    desbloquearSistema();
  }, TEMPO_BLOQUEIO);
}

// Desbloquear sistema
function desbloquearSistema() {
  bloqueado = false;
  tentativasErradas = 0;
  
  // Reabilita controles
  pinInputs.forEach(input => {
    input.disabled = false;
    input.classList.remove('error');
  });
  btnLimpar.disabled = false;
  
  limparPIN();
  esconderErro();
  
  // Mensagem de desbloqueio
  setTimeout(() => {
    pinInputs[0].focus();
  }, 100);
}

// Autenticar usu√°rio (salva no sessionStorage)
function autenticarUsuario() {
  const agora = new Date().getTime();
  const dadosAutenticacao = {
    autenticado: true,
    timestamp: agora,
    expira: agora + TEMPO_SESSAO
  };
  
  sessionStorage.setItem('auth_carregamento_mm', JSON.stringify(dadosAutenticacao));
  
  // Reset das tentativas
  tentativasErradas = 0;
  
  console.log('‚úÖ Usu√°rio autenticado com sucesso!');
}

// Verificar se usu√°rio est√° autenticado
function verificarAutenticacao() {
  try {
    const dados = sessionStorage.getItem('auth_carregamento_mm');
    if (!dados) return false;
    
    const auth = JSON.parse(dados);
    const agora = new Date().getTime();
    
    // Verifica se n√£o expirou
    if (auth.autenticado && agora < auth.expira) {
      return true;
    } else {
      // Remove autentica√ß√£o expirada
      sessionStorage.removeItem('auth_carregamento_mm');
      return false;
    }
  } catch (error) {
    console.error('Erro ao verificar autentica√ß√£o:', error);
    return false;
  }
}

// Mostrar tela de login
function mostrarLogin() {
  loginOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  // Esconde o conte√∫do principal
  const container = document.querySelector('.container');
  if (container) {
    container.style.display = 'none';
  }
}

// Ocultar tela de login
function ocultarLogin() {
  loginOverlay.style.display = 'none';
  document.body.style.overflow = 'auto';
  
  // Mostra o conte√∫do principal
  const container = document.querySelector('.container');
  if (container) {
    container.style.display = 'block';
  }
}

// Logout (fun√ß√£o p√∫blica para usar em bot√µes)
function logout() {
  if (confirm('üö™ Tem certeza que deseja sair do sistema?')) {
    sessionStorage.removeItem('auth_carregamento_mm');
    mostrarLogin();
    limparPIN();
    
    // Opcional: limpar dados sens√≠veis
    // sessionManager.saveCurrentSession(); // Salva antes de sair
  }
}

// Verifica√ß√£o peri√≥dica da autentica√ß√£o (a cada 5 minutos)
setInterval(() => {
  if (!verificarAutenticacao()) {
    mostrarLogin();
    alert('üïê Sua sess√£o expirou. Fa√ßa login novamente.');
  }
}, 5 * 60 * 1000);

// ========== INICIALIZA√á√ÉO ==========

// Modifica a inicializa√ß√£o existente para incluir o login
const inicializacaoOriginal = window.addEventListener;

// Adiciona a inicializa√ß√£o do login junto com a original
window.addEventListener("load", () => {
  // Inicializa o sistema de login PRIMEIRO
  inicializarLogin();
  
  // S√≥ inicializa o sistema principal se estiver autenticado
  if (verificarAutenticacao()) {
    // C√≥digo de inicializa√ß√£o original aqui...
    sessionManager = new SessionManager();
    gerarCheckboxesRotas();
    setupAutocomplete();
    setupAutoSave();
    console.log('Sistema inicializado. Sess√£o atual:', sessionManager.currentSessionId);
  }
});

// ========== FUN√á√ïES AUXILIARES ==========

// Fun√ß√£o para adicionar bot√£o de logout (opcional)
function adicionarBotaoLogout() {
  const sessionControls = document.querySelector('.session-controls');
  if (sessionControls) {
    const logoutBtn = document.createElement('button');
    logoutBtn.type = 'button';
    logoutBtn.className = 'btn btn-danger btn-small';
    logoutBtn.innerHTML = '<i class="bi bi-box-arrow-right"></i> Sair';
    logoutBtn.onclick = logout;
    sessionControls.appendChild(logoutBtn);
  }
}

// Chama a fun√ß√£o para adicionar bot√£o de logout ap√≥s carregar
setTimeout(() => {
  if (verificarAutenticacao()) {
    adicionarBotaoLogout();
  }
}, 1000);

// ========== CONFIGURA√á√ïES DE SEGURAN√áA ==========

// Desabilita algumas funcionalidades quando n√£o autenticado
document.addEventListener('keydown', (e) => {
  if (!verificarAutenticacao()) {
    // Bloqueia F12, Ctrl+Shift+I, etc.
    if (e.key === 'F12' || 
        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
        (e.ctrlKey && e.shiftKey && e.key === 'C') ||
        (e.ctrlKey && e.key === 'u')) {
      e.preventDefault();
      return false;
    }
  }
});

// Bloqueia clique direito quando n√£o autenticado
document.addEventListener('contextmenu', (e) => {
  if (!verificarAutenticacao()) {
    e.preventDefault();
    return false;
  }
});

console.log('üîê Sistema de autentica√ß√£o PIN carregado!');
console.log('üì± PIN atual configurado para demonstra√ß√£o: 1234');
console.log('‚ö†Ô∏è  LEMBRE-SE DE ALTERAR O PIN_CORRETO na linha 304!');

  </script>


</body>
</html>